# 🧪 Hash Refactor Testing Checklist

## Pre-Deployment Verification

### Database Deployment Check
- [ ] Deployed `DEPLOY_HASH_REFACTOR.sql` to Supabase
- [ ] Verified `create_card` has 12 parameters:
  ```sql
  SELECT proname, pronargs FROM pg_proc WHERE proname = 'create_card';
  -- Expected: 12 (was 10)
  ```
- [ ] Verified `create_content_item` has 10 parameters:
  ```sql
  SELECT proname, pronargs FROM pg_proc WHERE proname = 'create_content_item';
  -- Expected: 10 (was 8)
  ```
- [ ] Verified triggers exist:
  ```sql
  SELECT tgname FROM pg_trigger WHERE tgname LIKE '%content_hash%';
  -- Expected: trigger_update_card_content_hash, trigger_update_content_item_content_hash
  ```

---

## Core Functionality Tests

### Test 1: Normal Card Creation (No Import)
**Purpose**: Verify triggers still auto-calculate hash

Steps:
1. Create new card via UI
2. Add name and description
3. Save card
4. Check database:
   ```sql
   SELECT content_hash FROM cards WHERE name = 'Test Card';
   -- Should NOT be NULL
   ```

**Expected**: ✅ Hash auto-generated by trigger

---

### Test 2: Card with Translations
**Purpose**: Verify translation workflow still works

Steps:
1. Create card with content items
2. Translate to zh-Hant (or any language)
3. Check Translation Management
4. Verify status shows "Up to Date"

**Expected**: ✅ Translation status correct, hash matches

---

### Test 3: Export Card Without Translations
**Purpose**: Verify export includes hash column

Steps:
1. Create simple card (no translations)
2. Export to Excel
3. Open Excel, unhide Column K (Card sheet)
4. Check if content_hash is present

**Expected**: ✅ Column K contains hash value

---

### Test 4: Import Card Without Translations
**Purpose**: Verify 1-step import works

Steps:
1. Delete original card
2. Import Excel file from Test 3
3. Monitor import process (should be quick)
4. Verify card created successfully

**Expected**: ✅ Import completes in 1 step, card recreated

---

### Test 5: Export Card With Translations ⭐
**Purpose**: Verify complete data preservation

Steps:
1. Create card with content items
2. Translate to zh-Hant
3. Verify Translation Management shows "Up to Date"
4. Export to Excel
5. Open Excel:
   - Unhide Column K (Card sheet) → Check content_hash
   - Unhide Column J (Content sheet) → Check content_hash
   - Unhide Column J (Card sheet) → Check translations JSON
   - Unhide Column I (Content sheet) → Check translations JSON

**Expected**: 
- ✅ All hidden columns populated
- ✅ content_hash values present
- ✅ translations JSON contains translation data

---

### Test 6: Import Card With Translations ⭐⭐⭐
**Purpose**: THE CRITICAL TEST - Verify 1-step import preserves everything

Steps:
1. Use Excel file from Test 5
2. Delete original card
3. Import Excel file
4. **IMMEDIATELY** check Translation Management
5. Verify status shows "Up to Date" (NOT "Outdated")
6. Check translated content displays correctly
7. Verify all content items imported

**Expected**: 
- ✅ Import completes quickly (1 RPC per entity)
- ✅ Translations show "Up to Date" immediately
- ✅ No "Outdated" status
- ✅ All translated content preserved
- ✅ All content items present

**THIS IS THE KEY TEST** - If this works, refactor is successful!

---

### Test 7: Edit Card After Import
**Purpose**: Verify hash updates correctly on content change

Steps:
1. Import card with translations (from Test 6)
2. Edit card name or description
3. Save changes
4. Check Translation Management
5. Verify status changed to "Outdated"

**Expected**: 
- ✅ Edited translations marked "Outdated"
- ✅ Unedited languages remain "Up to Date"

---

### Test 8: Large Card Import
**Purpose**: Verify performance improvement

Steps:
1. Create card with 10-20 content items
2. Translate to multiple languages (2-3)
3. Export to Excel
4. Delete original
5. **TIME THE IMPORT**
6. Import Excel file
7. Verify all translations "Up to Date"

**Expected**:
- ✅ Import faster than before (no 3-step process)
- ✅ All 10-20 items imported
- ✅ All translations preserved
- ✅ All show "Up to Date"

---

### Test 9: Mixed Language Card
**Purpose**: Verify multiple languages preserved

Steps:
1. Create card
2. Translate to 3+ languages (en, zh-Hant, ja)
3. Export
4. Import
5. Check each language translation status

**Expected**: ✅ All languages show "Up to Date"

---

### Test 10: Content Item Translations
**Purpose**: Verify content items preserve translations

Steps:
1. Create card with content items
2. Translate content items
3. Export
4. Import
5. Navigate to content item details
6. Check translated content displays

**Expected**: ✅ Content item translations preserved

---

## Edge Cases

### Edge Case 1: Empty Translations
**Purpose**: Verify import works without translations

Steps:
1. Create card (no translations)
2. Export
3. Import
4. Verify success

**Expected**: ✅ Works fine (hash auto-calculated if NULL)

---

### Edge Case 2: Partial Translations
**Purpose**: Verify partial translation preservation

Steps:
1. Create card with 5 content items
2. Translate only 3 items
3. Export
4. Import
5. Verify only 3 items have translations

**Expected**: ✅ Partial translations preserved correctly

---

### Edge Case 3: Old Excel Format
**Purpose**: Verify backward compatibility

Steps:
1. Use old Excel export (without content_hash column)
2. Import
3. Verify success (hash auto-calculated)

**Expected**: ✅ Works with fallback to auto-calculation

---

## Regression Tests

### Regression 1: Normal Update Still Works
Steps:
1. Create card
2. Update name via UI
3. Verify hash recalculated

**Expected**: ✅ Hash updates on content change

---

### Regression 2: Translation System Still Works
Steps:
1. Create card
2. Translate via UI (not import)
3. Verify translation stored correctly

**Expected**: ✅ Translation workflow unchanged

---

### Regression 3: Batch Issuance Still Works
Steps:
1. Create card
2. Issue batch
3. Verify issued cards work

**Expected**: ✅ No impact on issuance

---

## Performance Metrics

### Measure Import Speed
Track these metrics before/after refactor:

| Card Size | Before (3-step) | After (1-step) | Improvement |
|-----------|-----------------|----------------|-------------|
| 1 item | 6 RPCs | 2 RPCs | 66% |
| 5 items | 18 RPCs | 6 RPCs | 66% |
| 10 items | 33 RPCs | 11 RPCs | 66% |
| 20 items | 63 RPCs | 21 RPCs | 66% |

**Measure**:
- Open browser DevTools → Network tab
- Filter by "rpc"
- Count create_card + create_content_item calls
- Should match "After" column

---

## Debugging

### If Import Shows "Outdated" Status

**Check**:
1. Excel Column K/J has content_hash values
2. Translations JSON contains content_hash
3. Database trigger deployed correctly
4. Frontend code updated

**SQL Debug**:
```sql
-- Check imported card
SELECT content_hash, translations FROM cards WHERE name = 'Test Card';

-- Check if hashes match
SELECT 
  content_hash as current_hash,
  translations->'zh-Hant'->>'content_hash' as translation_hash,
  content_hash = (translations->'zh-Hant'->>'content_hash') as hashes_match
FROM cards 
WHERE name = 'Test Card';
```

**Expected**: `hashes_match` should be `true`

---

### If Hash Not Auto-Calculated

**Check**:
1. Trigger deployed: 
   ```sql
   SELECT tgname FROM pg_trigger WHERE tgname = 'trigger_update_card_content_hash';
   ```
2. Trigger function updated:
   ```sql
   SELECT prosrc FROM pg_proc WHERE proname = 'update_card_content_hash';
   -- Should contain "IF NEW.content_hash IS NULL"
   ```

---

## Sign-Off

After completing all tests:

- [ ] All core functionality tests passed
- [ ] All edge cases handled
- [ ] All regression tests passed
- [ ] Performance improvement verified
- [ ] No breaking changes detected

**Tested By**: _______________  
**Date**: _______________  
**Status**: ⬜ PASS / ⬜ FAIL  

**Notes**:
_______________________________________________________
_______________________________________________________
_______________________________________________________

---

## Quick Test (5 minutes)

If short on time, run these critical tests:

1. ✅ **Test 6**: Import card with translations → Check "Up to Date"
2. ✅ **Test 1**: Create new card → Check hash auto-generated
3. ✅ **Test 7**: Edit imported card → Check "Outdated"

If all 3 pass → Refactor successful! ✅

