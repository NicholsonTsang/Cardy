# üîë Client-Side vs Server-Side: The Key Difference Explained

## The Confusion

**Question**: "Payment functions are called by Edge Functions, so why are they client-side?"

**Answer**: It's not about WHERE they're called from, it's about **WHICH API KEY** the Edge Function uses!

---

## üîç The Key Difference

The distinction between client-side and server-side is determined by **which Supabase client the Edge Function creates**:

| Pattern | API Key Used | PostgreSQL Role | Can Use `auth.uid()`? |
|---------|-------------|-----------------|----------------------|
| **Client-Side** | `ANON_KEY` + User JWT | `authenticated` | ‚úÖ Yes (returns user ID) |
| **Server-Side** | `SERVICE_ROLE_KEY` | `service_role` | ‚ùå No (returns NULL) |

---

## üìä Visual Comparison

### Payment Functions (Client-Side Pattern)

**Edge Function: `create-checkout-session/index.ts`**

```typescript
// ‚ö†Ô∏è LOOK AT THIS LINE! Uses ANON_KEY, not SERVICE_ROLE_KEY!
const supabaseClient = createClient(
  Deno.env.get('SUPABASE_URL') ?? '',
  Deno.env.get('SUPABASE_ANON_KEY') ?? '',      // ‚Üê ANON KEY!
  {
    global: {
      headers: { Authorization: req.headers.get('Authorization')! },  // ‚Üê User JWT!
    },
  }
);

// This means:
// - Supabase client executes as 'authenticated' role
// - auth.uid() returns the user's ID (from JWT)
// - Functions need GRANT TO authenticated
```

**Stored Procedure: `create_batch_checkout_payment`**

```sql
CREATE OR REPLACE FUNCTION create_batch_checkout_payment(...)
RETURNS UUID LANGUAGE plpgsql SECURITY DEFINER AS $$
BEGIN
    -- ‚úÖ This works because Edge Function passes user JWT!
    IF v_batch_owner_id != auth.uid() THEN  -- auth.uid() returns user ID
        RAISE EXCEPTION 'Not authorized';
    END IF;
    -- ...
END;
$$;

-- ‚úÖ Grant to authenticated (the role used by Edge Function)
GRANT EXECUTE ON FUNCTION create_batch_checkout_payment(...) TO authenticated;
```

**Why it's called "Client-Side"**:
- Even though called by Edge Function
- It uses **user credentials** (anon key + JWT)
- Executes as `authenticated` role
- `auth.uid()` works (returns user ID from JWT)
- Pattern is the same as if frontend called it directly

---

### Translation Function (Server-Side Pattern)

**Edge Function: `translate-card-content/index.ts`**

```typescript
// ‚ö†Ô∏è LOOK AT THIS LINE! Uses SERVICE_ROLE_KEY!
const supabaseAdmin = createClient(
  SUPABASE_URL, 
  SUPABASE_SERVICE_ROLE_KEY  // ‚Üê SERVICE ROLE KEY!
);

// Manually validate user from JWT
const token = req.headers.get('Authorization')?.replace('Bearer ', '');
const { data: { user }, error } = await supabaseAdmin.auth.getUser(token);

// This means:
// - Supabase client executes as 'service_role'
// - auth.uid() returns NULL (no user context)
// - Must pass user.id explicitly to stored procedures
// - Functions need GRANT TO service_role
```

**Stored Procedure: `store_card_translations`**

```sql
CREATE OR REPLACE FUNCTION store_card_translations(
  p_user_id UUID,  -- ‚ö†Ô∏è Explicit parameter! Can't use auth.uid()
  p_card_id UUID,
  ...
)
RETURNS JSONB SECURITY DEFINER AS $$
BEGIN
  -- ‚úÖ Validate against explicit parameter
  SELECT user_id INTO v_card_owner FROM cards WHERE id = p_card_id;
  
  IF v_card_owner != p_user_id THEN  -- ‚ö†Ô∏è Use parameter, not auth.uid()!
    RAISE EXCEPTION 'Unauthorized';
  END IF;
  -- ...
END;
$$;

-- ‚úÖ Grant ONLY to service_role (Edge Function uses service_role)
GRANT EXECUTE ON FUNCTION store_card_translations(...) TO service_role;
```

**Why it's called "Server-Side"**:
- Called by Edge Function with **service role key**
- No user context in PostgreSQL (auth.uid() = NULL)
- Must pass user ID explicitly
- Only `service_role` can call it
- Frontend **cannot** call it directly

---

## üéØ Side-by-Side Comparison

### Payment Functions (Client-Side)
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê      ANON_KEY + User JWT      ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   Frontend  ‚îÇ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ> ‚îÇ  Edge Function   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                                ‚îÇ (create-checkout)‚îÇ
                                               ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                                                        ‚îÇ
                                   Uses ANON_KEY + JWT  ‚îÇ
                                                        ‚ñº
                                               ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                                               ‚îÇ   Supabase DB    ‚îÇ
                                               ‚îÇ (authenticated)  ‚îÇ
                                               ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                                                        ‚îÇ
                         auth.uid() = user's ID ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ>‚îÇ
                                                        ‚ñº
                                          ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                                          ‚îÇ create_batch_checkout_   ‚îÇ
                                          ‚îÇ payment() function       ‚îÇ
                                          ‚îÇ GRANT TO authenticated   ‚îÇ
                                          ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### Translation Functions (Server-Side)
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê         User JWT              ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   Frontend  ‚îÇ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ> ‚îÇ  Edge Function   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                                ‚îÇ (translate)      ‚îÇ
                                               ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                                                        ‚îÇ
                              Uses SERVICE_ROLE_KEY    ‚îÇ
                              + validates JWT manually ‚îÇ
                                                        ‚ñº
                                               ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                                               ‚îÇ   Supabase DB    ‚îÇ
                                               ‚îÇ (service_role)   ‚îÇ
                                               ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                                                        ‚îÇ
                         auth.uid() = NULL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÇ
                         Must pass user.id explicitly  ‚îÇ
                                                        ‚ñº
                                          ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                                          ‚îÇ store_card_translations()‚îÇ
                                          ‚îÇ function                 ‚îÇ
                                          ‚îÇ GRANT TO service_role    ‚îÇ
                                          ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## ü§î Why Does This Matter?

### Security Implications

**Client-Side Pattern**:
- ‚úÖ Frontend **CAN** call functions directly
- ‚úÖ `auth.uid()` works (user from JWT)
- ‚ö†Ô∏è Must validate ownership in function
- ‚ö†Ô∏è Can't bypass RLS without SECURITY DEFINER

**Server-Side Pattern**:
- ‚ùå Frontend **CANNOT** call functions directly
- ‚ùå `auth.uid()` returns NULL
- ‚úÖ More secure isolation
- ‚úÖ Can bypass RLS for privileged operations

---

## üìã Decision Tree

```
Is your Edge Function using:

‚îå‚îÄ ANON_KEY + User JWT?
‚îÇ  ‚îî‚îÄ> YES ‚îÄ> Functions are CLIENT-SIDE
‚îÇ              - Keep in client-side/ folder
‚îÇ              - Use auth.uid() in functions
‚îÇ              - GRANT TO authenticated
‚îÇ              - Frontend CAN call directly
‚îÇ
‚îî‚îÄ SERVICE_ROLE_KEY?
   ‚îî‚îÄ> YES ‚îÄ> Functions are SERVER-SIDE
               - Keep in server-side/ folder
               - Accept p_user_id parameter
               - DON'T use auth.uid()
               - GRANT TO service_role
               - Frontend CANNOT call directly
```

---

## üîç How to Check Your Code

### Step 1: Look at Edge Function

```typescript
// Find this line in your Edge Function:
const client = createClient(
  url,
  KEY_HERE,  // ‚Üê What key is used?
  ...
);
```

**If `KEY_HERE` is**:
- `SUPABASE_ANON_KEY` ‚Üí Client-side pattern
- `SUPABASE_SERVICE_ROLE_KEY` ‚Üí Server-side pattern

### Step 2: Look at Stored Procedure

```sql
-- Does function use auth.uid()?
IF v_something != auth.uid() THEN  -- ‚Üê Using auth.uid()?
```

**If uses `auth.uid()`**: Client-side pattern  
**If accepts `p_user_id` parameter**: Server-side pattern

---

## ‚úÖ Your Specific Case: Payment Functions

### What You Have

**Edge Function (`create-checkout-session/index.ts`)**:
```typescript
const supabaseClient = createClient(
  Deno.env.get('SUPABASE_URL') ?? '',
  Deno.env.get('SUPABASE_ANON_KEY') ?? '',  // ‚Üê ANON KEY!
  { global: { headers: { Authorization: req.headers.get('Authorization')! } } }
);
```

**Stored Procedure**:
```sql
IF v_batch_owner_id != auth.uid() THEN  -- ‚Üê Uses auth.uid()!
    RAISE EXCEPTION 'Not authorized';
END IF;
```

**Conclusion**: CLIENT-SIDE pattern!

### Why It Works

1. Edge Function uses **ANON_KEY + User JWT**
2. PostgreSQL sees this as `authenticated` role
3. `auth.uid()` extracts user ID from JWT ‚Üí Returns user's actual ID
4. Function checks: "Does this batch belong to this user?"
5. Works perfectly! ‚úÖ

### Why We Moved It

**Before (Wrong)**:
- File location: `server-side/` folder
- But pattern: Client-side (uses auth.uid())
- Missing: GRANT statements
- Result: Confusing and insecure

**After (Correct)**:
- File location: `client-side/` folder
- Pattern matches: Uses auth.uid() + GRANT to authenticated
- Clear: Everyone understands it's client-side pattern
- Secure: Proper GRANT statements

---

## üí° Key Takeaway

**"Client-Side" vs "Server-Side" is NOT about WHERE the function is called from.**

**It's about WHICH API KEY the caller uses:**

| If Using | Then It's | PostgreSQL Role | Use auth.uid()? | GRANT TO |
|----------|-----------|----------------|-----------------|----------|
| ANON_KEY + User JWT | **Client-Side** | `authenticated` | ‚úÖ Yes | `authenticated` |
| SERVICE_ROLE_KEY | **Server-Side** | `service_role` | ‚ùå No | `service_role` |

---

## üéì Examples in Your Codebase

### Client-Side Functions
- ‚úÖ Payment management (uses ANON_KEY)
- ‚úÖ Card CRUD operations (uses auth.uid())
- ‚úÖ Content management (uses auth.uid())
- ‚úÖ Most authenticated user operations

### Server-Side Functions
- ‚úÖ Translation storage (uses SERVICE_ROLE_KEY)
- ‚úÖ Credit purchase completion (uses SERVICE_ROLE_KEY)
- ‚úÖ Credit refunds (uses SERVICE_ROLE_KEY)
- ‚úÖ Privileged operations called by webhooks

---

## üìö Summary

**Payment functions are "client-side" because:**

1. ‚úÖ Edge Function uses **ANON_KEY** (not SERVICE_ROLE_KEY)
2. ‚úÖ Functions use **auth.uid()** (works with user JWT)
3. ‚úÖ Execute as **authenticated** role (not service_role)
4. ‚úÖ Pattern is same as frontend calling directly
5. ‚úÖ Security maintained by ownership checks

**Even though they're called by Edge Functions**, they follow the **client-side authentication pattern**!

---

Does this make sense now? The folder name isn't about "who calls it", it's about "which authentication pattern it uses"! üéØ

