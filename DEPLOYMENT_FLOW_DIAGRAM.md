# CardStudio Deployment Flow Diagram

## Overview Flowchart

```
┌─────────────────────────────────────────────────────────────────┐
│                    DEPLOYMENT PREPARATION                        │
│  ✓ Supabase Project Created                                     │
│  ✓ OpenAI API Key Ready                                         │
│  ✓ Stripe Account Setup                                         │
│  ✓ Domain Configured (optional)                                 │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│                  PART 1: ENVIRONMENT SETUP                       │
│  1. Copy .env.example → .env                                    │
│  2. Configure VITE_SUPABASE_URL                                 │
│  3. Configure VITE_SUPABASE_ANON_KEY                            │
│  4. Configure VITE_STRIPE_PUBLISHABLE_KEY                       │
│  5. Configure OpenAI settings                                   │
│  6. Configure business settings                                 │
│  ✓ Verify all variables set                                     │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│              PART 2A: DATABASE DEPLOYMENT                        │
│  Execute in Supabase Dashboard > SQL Editor:                    │
│  1. schema.sql        ← Tables, enums, indexes                  │
│  2. all_stored_procedures.sql  ← All RPC functions              │
│     (generated by ./scripts/combine-storeproc.sh)               │
│  3. policy.sql        ← RLS policies                            │
│  4. triggers.sql      ← Database triggers                       │
│  ✓ Verify with SQL queries                                      │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│            PART 2B: STORAGE BUCKET SETUP                         │
│  Create in Supabase Dashboard > Storage:                        │
│  1. userfiles (public bucket)                                   │
│  ✓ Bucket is public                                             │
│  ✓ Storage policies applied (from policy.sql)                   │
│  Note: App creates folders automatically:                       │
│    - {user_id}/card-images/                                     │
│    - {user_id}/content-images/                                  │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│          PART 2C: AUTHENTICATION CONFIGURATION                   │
│  Configure in Supabase Dashboard > Authentication:              │
│  1. Set Site URL (https://your-domain.com)                      │
│  2. Add Redirect URLs:                                          │
│     - https://your-domain.com/reset-password                    │
│     - https://your-domain.com/cms/mycards                       │
│  3. Customize email templates                                   │
│  ✓ Test signup email                                            │
│  ✓ Test password reset email                                    │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│          PART 3A: EDGE FUNCTION SECRETS                          │
│  Option 1: ./scripts/setup-production-secrets.sh                │
│  Option 2: Manual setup:                                        │
│     npx supabase secrets set OPENAI_API_KEY=sk-...              │
│     npx supabase secrets set STRIPE_SECRET_KEY=sk_live_...      │
│     npx supabase secrets set OPENAI_REALTIME_MODEL=gpt-...      │
│     npx supabase secrets set STRIPE_WEBHOOK_SECRET=whsec_...    │
│  ✓ Verify: npx supabase secrets list                            │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│          PART 3B: EDGE FUNCTIONS DEPLOYMENT                      │
│  Option 1: ./scripts/deploy-edge-functions.sh (all at once)     │
│  Option 2: Deploy individually:                                 │
│     npx supabase functions deploy chat-with-audio               │
│     npx supabase functions deploy chat-with-audio-stream        │
│     npx supabase functions deploy generate-tts-audio            │
│     npx supabase functions deploy openai-realtime-token         │
│     npx supabase functions deploy translate-card-content        │
│     npx supabase functions deploy create-credit-checkout-session│
│     npx supabase functions deploy handle-credit-purchase-success│
│     npx supabase functions deploy stripe-credit-webhook         │
│  ✓ Verify: npx supabase functions list                          │
│  ✓ Check logs for errors                                        │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│          PART 3C: STRIPE WEBHOOK SETUP                           │
│  In Stripe Dashboard > Webhooks:                                │
│  1. Create endpoint:                                            │
│     URL: https://project.supabase.co/functions/v1/stripe-...    │
│  2. Select events:                                              │
│     - checkout.session.completed                                │
│     - checkout.session.async_payment_succeeded                  │
│     - checkout.session.async_payment_failed                     │
│     - charge.refunded                                           │
│  3. Copy webhook secret → Update Edge Function secret           │
│  4. Redeploy stripe-credit-webhook                              │
│  ✓ Test webhook with test event                                 │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│              PART 4A: FRONTEND BUILD                             │
│  1. npm run build:production                                    │
│  ✓ dist/ folder created                                         │
│  ✓ No build errors                                              │
│  ✓ npm run type-check passes                                    │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│          PART 4B: FRONTEND DEPLOYMENT                            │
│  Option 1: Vercel                                               │
│     vercel --prod                                               │
│  Option 2: Netlify                                              │
│     netlify deploy --prod                                       │
│  Option 3: Firebase Hosting                                     │
│     firebase deploy --only hosting                              │
│  ✓ Deployed successfully                                        │
│  ✓ Environment variables set in hosting dashboard               │
│  ✓ SSL certificate active                                       │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│            PART 4C: DOMAIN CONFIGURATION                         │
│  1. Configure DNS records                                       │
│  2. Point domain to hosting provider                            │
│  3. Enable SSL/HTTPS                                            │
│  4. Configure www redirect (optional)                           │
│  ✓ Domain accessible                                            │
│  ✓ HTTPS working                                                │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│          PART 5: POST-DEPLOYMENT VERIFICATION                    │
│  ✓ Database verification (SQL queries)                          │
│  ✓ Authentication flow test                                     │
│  ✓ Credit system test                                           │
│  ✓ Card creation test                                           │
│  ✓ Translation test                                             │
│  ✓ Batch issuance test                                          │
│  ✓ Mobile client test                                           │
│  ✓ Edge Functions test                                          │
│  ✓ Admin functions test                                         │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│            PART 6: MONITORING & MAINTENANCE                      │
│  ✓ Database monitoring enabled                                  │
│  ✓ Edge Function logs reviewed                                  │
│  ✓ Error tracking configured (optional)                         │
│  ✓ Backup strategy documented                                   │
│  ✓ Update procedures documented                                 │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│                      🎉 LAUNCH READY! 🎉                         │
│  ✓ All systems operational                                      │
│  ✓ All tests passing                                            │
│  ✓ Monitoring active                                            │
│  ✓ Team trained                                                 │
└─────────────────────────────────────────────────────────────────┘
```

## Critical Dependencies

```
Environment Variables
        ↓
Database Schema
        ↓
Stored Procedures  ←─────┐
        ↓                │
RLS Policies             │
        ↓                │
Database Triggers        │
        ↓                │
Storage Buckets          │
        ↓                │
Auth Configuration       │
        ↓                │
Edge Function Secrets    │
        ↓                │
Edge Functions ──────────┘
        ↓
Stripe Webhook
        ↓
Frontend Build
        ↓
Frontend Deployment
```

## Parallel Tasks (Can Be Done Simultaneously)

After database is set up, these can run in parallel:

```
Database ────────┬────→ Storage Buckets
                 ├────→ Auth Configuration
                 └────→ Edge Function Secrets

Edge Function Secrets ────→ Edge Functions Deployment

Edge Functions Deployed ───→ Stripe Webhook Setup

Frontend ────────┬────→ Build
                 └────→ Deployment
```

## Update Flow (Existing Deployment)

### Database Update
```
Edit sql/storeproc/client-side/*.sql or server-side/*.sql
        ↓
./scripts/combine-storeproc.sh
        ↓
Copy sql/all_stored_procedures.sql
        ↓
Paste in Supabase Dashboard > SQL Editor
        ↓
Execute
        ↓
Verify functions updated
```

### Edge Function Update
```
Edit supabase/functions/<function-name>/index.ts
        ↓
Test locally: npx supabase functions serve <function-name>
        ↓
Deploy: npx supabase functions deploy <function-name>
        ↓
Check logs: npx supabase functions logs <function-name>
        ↓
Verify functionality
```

### Frontend Update
```
Edit Vue components/stores
        ↓
Test locally: npm run dev:local
        ↓
Build: npm run build:production
        ↓
Deploy to hosting provider
        ↓
Clear CDN cache (if applicable)
        ↓
Verify on production
```

## Common Pitfall Prevention

### ❌ Don't Do This:
```
Deploy Edge Functions BEFORE setting secrets
        ↓
    Functions fail with API errors
```

### ✅ Do This Instead:
```
Set Edge Function secrets FIRST
        ↓
THEN deploy Edge Functions
        ↓
Functions work correctly
```

---

### ❌ Don't Do This:
```
Forget to whitelist /reset-password URL
        ↓
Password reset emails redirect to 404
```

### ✅ Do This Instead:
```
Add /reset-password to Supabase Auth redirect URLs
        ↓
Password reset works correctly
```

---

### ❌ Don't Do This:
```
Deploy schema.sql after stored procedures
        ↓
Functions reference non-existent tables
```

### ✅ Do This Instead:
```
Deploy in order: schema → procedures → policies → triggers
        ↓
Everything works correctly
```

---

## Time Estimates

| Part | Task | Estimated Time |
|------|------|----------------|
| Part 1 | Environment Variables | 15 minutes |
| Part 2A | Database Deployment | 10 minutes |
| Part 2B | Storage Buckets | 5 minutes |
| Part 2C | Auth Configuration | 10 minutes |
| Part 3A | Edge Function Secrets | 10 minutes |
| Part 3B | Edge Functions Deploy | 15 minutes |
| Part 3C | Stripe Webhook | 10 minutes |
| Part 4A | Frontend Build | 5 minutes |
| Part 4B | Frontend Deploy | 10 minutes |
| Part 4C | Domain Config | 30 minutes |
| Part 5 | Verification | 45 minutes |
| Part 6 | Monitoring Setup | 20 minutes |
| **TOTAL** | **First-Time Deployment** | **~3 hours** |

**Subsequent deployments**: 30-60 minutes (depending on what changed)

## Quick Reference Commands

```bash
# Complete deployment from scratch
./scripts/combine-storeproc.sh                    # Generate procedures
./scripts/setup-production-secrets.sh             # Setup secrets
./scripts/deploy-edge-functions.sh                # Deploy functions
npm run build:production                          # Build frontend
vercel --prod                                     # Deploy (example)

# Update procedures only
./scripts/combine-storeproc.sh
# Then execute sql/all_stored_procedures.sql in Supabase

# Update Edge Functions only
npx supabase functions deploy <function-name>

# Update frontend only
npm run build:production
# Then deploy to hosting provider
```

---

**Reference**: See `DEPLOYMENT_COMPLETE_GUIDE.md` for detailed instructions for each step.

